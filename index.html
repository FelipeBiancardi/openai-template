<!DOCTYPE html>
<html>

<head>
    <title>Repasse de informações GOV</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@zxing/library@0.17.0/umd/index.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="max-w-md bg-white p-6 rounded-md shadow-md w-full md:w-auto">
        <h1 class="text-2xl font-semibold mb-4">Leitura QRCode GOV.BR - v.1.0.0</h1>
        <video id="preview" class="w-full mb-4"></video>
        <div id="parsedContent" class="text-sm"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const codeReader = new ZXing.BrowserQRCodeReader();

        const videoElement = document.getElementById('preview');
        const parsedContentElement = document.getElementById('parsedContent');

        codeReader
            .listVideoInputDevices()
            .then((videoInputDevices) => {
                if (videoInputDevices.length > 0) {
                    codeReader
                        .decodeFromVideoDevice(videoInputDevices[0].deviceId, videoElement, (result, err) => {
                            if (result) {
                                const {parsedContent, dados} = parseVCard(result.text);
                                parsedContentElement.innerText = parsedContent;
                                axios.post("https://exemplo-integracao-cliente.bohr.io/api/integracao", dados)
                                    .then(function(response) {
                                        console.log(response);
                                    })
                                    .catch(function(error) {
                                        console.log(error);
                                    });
                            }
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.error(err);
                            }
                        });
                } else {
                    console.error('No video input devices found.');
                }
            })
            .catch((err) => {
                console.error(err);
            });

        function parseVCard(content) {
            const lines = content.split('\n');
            let parsedContent = '';
            let fullName = '';
            let birthday = '';
            let dados = {}

            for (const line of lines) {
                if (line.startsWith('FN:')) {
                    fullName = line.substring(3);
                    dados.fullName = fullName
                } else if (line.startsWith('N:')) {
                    const nameParts = line.substring(2).split(';');
                    fullName = nameParts[1] + ' ' + nameParts[0];
                    dados.fullName = fullName
                } else if ((line.startsWith('ANNIVERSARY:') || line.startsWith('BDAY:')) && !birthday) {
                    birthday = 'Aniversário: ' + formatDate(line.substring(line.indexOf(':') + 1)) + '\n';
                    dados.birthday = birthday
                } else if (line.startsWith('GENDER:')) {
                    parsedContent += 'Gênero: ' + (line.substring(7) === 'M' ? 'Masculino' : 'Feminino') + '\n';
                    dados.genero = (line.substring(7) === 'M' ? 'Masculino' : 'Feminino')
                } else if (line.startsWith('EMAIL:')) {
                    parsedContent += 'Email: ' + line.substring(6) + '\n';
                    dados.email = line.substring(6)
                } else if (line.startsWith('TEL:')) {
                    parsedContent += 'Telefone: ' + line.substring(4) + '\n';
                    dados.telefone = line.substring(4)
                }
            }

            parsedContent = 'Nome: ' + fullName + '\n' + birthday + parsedContent;
            return {parsedContent, dados};
        }

        function formatDate(dateString) {
            const year = dateString.substr(0, 4);
            const month = dateString.substr(4, 2);
            const day = dateString.substr(6, 2);
            return `${day}/${month}/${year}`;
        }
    </script>
</body>

</html>